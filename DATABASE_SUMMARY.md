# –ö—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

## üìä –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

- **–í—Å–µ–≥–æ —Ç–∞–±–ª–∏—Ü:** 18
- **–û—Å–Ω–æ–≤–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü:** 10
- **–°–ø—Ä–∞–≤–æ—á–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü:** 3
- **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü:** 3
- **–°–ª—É–∂–µ–±–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü:** 2

## üîë –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏

### –ì–ª–∞–≤–Ω—ã–π –±–∏–∑–Ω–µ—Å-–∫–ª—é—á:
- **farms.bin** - –ë–ò–ù/–ò–ò–ù —Ö–æ–∑—è–π—Å—Ç–≤–∞ (12 —Ü–∏—Ñ—Ä, UNIQUE)
  - –°–≤—è–∑—ã–≤–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã —á–µ—Ä–µ–∑ farm_id
  - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ö–æ–∑—è–π—Å—Ç–≤–∞

### –î—Ä—É–≥–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏:
- **users.username** - –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (UNIQUE)
- **users.email** - email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (UNIQUE)
- **fields.field_code** - –∫–æ–¥ –ø–æ–ª—è (UNIQUE)
- **ref_crops.crop_name** - –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—É–ª—å—Ç—É—Ä—ã (UNIQUE)
- **ref_fertilizers.name** - –Ω–∞–∑–≤–∞–Ω–∏–µ —É–¥–æ–±—Ä–µ–Ω–∏—è (UNIQUE)

## üîó –ö–ª—é—á–µ–≤—ã–µ —Å–≤—è–∑–∏

```
farms (—Ü–µ–Ω—Ç—Ä —Å–∏—Å—Ç–µ–º—ã)
‚îÇ
‚îú‚îÄ‚îÄ users (farm_id ‚Üí farms.id)
‚îÇ   ‚îî‚îÄ‚îÄ –º–Ω–æ–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Üí –æ–¥–Ω–æ —Ö–æ–∑—è–π—Å—Ç–≤–æ
‚îÇ
‚îú‚îÄ‚îÄ fields (farm_id ‚Üí farms.id)
‚îÇ   ‚îú‚îÄ‚îÄ –æ–¥–Ω–æ —Ö–æ–∑—è–π—Å—Ç–≤–æ ‚Üí –º–Ω–æ–≥–æ –ø–æ–ª–µ–π
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ operations (field_id ‚Üí fields.id)
‚îÇ       ‚îú‚îÄ‚îÄ –æ–¥–Ω–æ –ø–æ–ª–µ ‚Üí –º–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ü–∏–π
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ sowing_details (1:1)
‚îÇ       ‚îú‚îÄ‚îÄ fertilizer_applications (1:M)
‚îÇ       ‚îú‚îÄ‚îÄ pesticide_applications (1:M)
‚îÇ       ‚îú‚îÄ‚îÄ harvest_data (1:1)
‚îÇ       ‚îî‚îÄ‚îÄ agrochemical_analyses (1:1)
‚îÇ
‚îú‚îÄ‚îÄ weather_data (farm_id ‚Üí farms.id)
‚îÇ
‚îî‚îÄ‚îÄ machinery (farm_id ‚Üí farms.id)
    ‚îú‚îÄ‚îÄ machinery_equipment (1:1)
    ‚îî‚îÄ‚îÄ gps_tracks (1:M)
```

## üìÅ –ì—Ä—É–ø–ø—ã —Ç–∞–±–ª–∏—Ü –ø–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

### 1. –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- `users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã
- `audit_logs` - –∂—É—Ä–Ω–∞–ª –≤—Å–µ—Ö –¥–µ–π—Å—Ç–≤–∏–π

### 2. –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ö–æ–∑—è–π—Å—Ç–≤–µ
- `farms` - —Ö–æ–∑—è–π—Å—Ç–≤–∞ (**—Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞**)
- `fields` - –ø–æ–ª—è —Å –ø–æ—á–≤–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
- `machinery` - —Ç–µ—Ö–Ω–∏–∫–∞
- `machinery_equipment` - GPS/RTK –æ—Å–Ω–∞—â–µ–Ω–∏–µ

### 3. –ê–≥—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- `operations` - –≤—Å–µ –≤–∏–¥—ã –æ–ø–µ—Ä–∞—Ü–∏–π
- `sowing_details` - –¥–µ—Ç–∞–ª–∏ –ø–æ—Å–µ–≤–∞
- `fertilizer_applications` - –≤–Ω–µ—Å–µ–Ω–∏–µ —É–¥–æ–±—Ä–µ–Ω–∏–π
- `pesticide_applications` - –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –°–ó–†
- `harvest_data` - –¥–∞–Ω–Ω—ã–µ —É–±–æ—Ä–∫–∏
- `agrochemical_analyses` - –ø–æ—á–≤–µ–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã

### 4. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- `phytosanitary_monitoring` - –±–æ–ª–µ–∑–Ω–∏/–≤—Ä–µ–¥–∏—Ç–µ–ª–∏/—Å–æ—Ä–Ω—è–∫–∏
- `satellite_data` - NDVI/EVI –∏–Ω–¥–µ–∫—Å—ã
- `gps_tracks` - —Ç—Ä–µ–∫–∏ —Ç–µ—Ö–Ω–∏–∫–∏
- `weather_data` - –ø–æ–≥–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

### 5. –≠–∫–æ–Ω–æ–º–∏–∫–∞
- `economic_data` - –∑–∞—Ç—Ä–∞—Ç—ã –∏ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å

### 6. –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏
- `ref_crops` - –∫—É–ª—å—Ç—É—Ä—ã
- `ref_fertilizers` - —É–¥–æ–±—Ä–µ–Ω–∏—è
- `ref_pesticides` - –°–ó–†

## ‚öôÔ∏è –í–∞–∂–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

### CASCADE DELETE
–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ö–æ–∑—è–π—Å—Ç–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è:
- –í—Å–µ –ø–æ–ª—è (fields)
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (operations)
- –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–π
- –ü–æ–≥–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (weather_data)
- –¢–µ—Ö–Ω–∏–∫–∞ –∏ GPS-—Ç—Ä–µ–∫–∏

### SET NULL
–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ö–æ–∑—è–π—Å—Ç–≤–∞ –ù–ï —É–¥–∞–ª—è—é—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:
- `users.farm_id` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –≤ NULL
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É —Ö–æ–∑—è–π—Å—Ç–≤—É

## üìù –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ (–ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤ production):

1. **–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏** ‚úÖ
   ```sql
   ALTER TABLE farms ADD CONSTRAINT farms_bin_unique UNIQUE (bin);
   ALTER TABLE users ADD CONSTRAINT users_username_unique UNIQUE (username);
   ALTER TABLE users ADD CONSTRAINT users_email_unique UNIQUE (email);
   ALTER TABLE fields ADD CONSTRAINT fields_field_code_unique UNIQUE (field_code);
   ```

2. **–°–æ—Å—Ç–∞–≤–Ω—ã–µ –∫–ª—é—á–∏** ‚úÖ
   ```sql
   ALTER TABLE economic_data ADD CONSTRAINT uk_economic_data UNIQUE (field_id, year, crop);
   ALTER TABLE weather_data ADD CONSTRAINT uk_weather_data UNIQUE (farm_id, datetime);
   ALTER TABLE satellite_data ADD CONSTRAINT uk_satellite_data UNIQUE (field_id, acquisition_date, satellite_source);
   ```

3. **–ò–Ω–¥–µ–∫—Å—ã** ‚úÖ
   - –ù–∞ farm_id –≤–æ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö
   - –ù–∞ –¥–∞—Ç–∞—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
   - –ù–∞ —Ç–∏–ø–∞—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

4. **CHECK Constraints** ‚úÖ
   - –ë–ò–ù –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 12 —Å–∏–º–≤–æ–ª–æ–≤
   - –ü–ª–æ—â–∞–¥–∏ >= 0
   - –†–æ–ª—å –≤ ('admin', 'farmer', 'viewer')
   - NDVI –º–µ–∂–¥—É -1 –∏ 1

### –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ (–¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è):

1. **–ü–∞—Ä—Ç–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ** –±–æ–ª—å—à–∏—Ö —Ç–∞–±–ª–∏—Ü:
   - `gps_tracks` –ø–æ –¥–∞—Ç–∞–º
   - `weather_data` –ø–æ –º–µ—Å—è—Ü–∞–º
   - `operations` –ø–æ –≥–æ–¥–∞–º

2. **–ê—Ä—Ö–∏–≤–∞—Ü–∏—è** —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
   - –ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ä—à–µ 3 –ª–µ—Ç –≤ –∞—Ä—Ö–∏–≤
   - –°–∂–∞—Ç–∏–µ GPS-—Ç—Ä–µ–∫–æ–≤

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –ë—ã—Å—Ç—Ä—ã–µ –∑–∞–ø—Ä–æ—Å—ã (—Å –∏–Ω–¥–µ–∫—Å–∞–º–∏):
```sql
-- –ü–æ–ª—É—á–∏—Ç—å —Ö–æ–∑—è–π—Å—Ç–≤–æ –ø–æ –ë–ò–ù
SELECT * FROM farms WHERE bin = '123456789012';

-- –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–æ–ª—è —Ö–æ–∑—è–π—Å—Ç–≤–∞
SELECT * FROM fields WHERE farm_id = 1;

-- –û–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞ –ø–µ—Ä–∏–æ–¥
SELECT * FROM operations
WHERE farm_id = 1 AND operation_date BETWEEN '2024-01-01' AND '2024-12-31';
```

### –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ JOIN'—ã:
```sql
-- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ø–æ–ª—è–º–∏ –∏ —Ö–æ–∑—è–π—Å—Ç–≤–∞–º–∏ (—á–µ—Ä–µ–∑ view)
SELECT * FROM v_operations_summary WHERE farm_bin = '123456789012';

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ö–æ–∑—è–π—Å—Ç–≤—É
SELECT * FROM v_farm_statistics WHERE bin = '123456789012';
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### Row Level Security (RLS)
- –§–µ—Ä–º–µ—Ä—ã –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–µ —Ö–æ–∑—è–π—Å—Ç–≤–æ
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –≤–∏–¥—è—Ç –≤—Å–µ
- –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –≤–∏–¥—è—Ç –Ω–∏—á–µ–≥–æ

### –ê—É–¥–∏—Ç
–í—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ `audit_logs`:
- –ö—Ç–æ (user_id)
- –ß—Ç–æ (action: create/update/delete)
- –ö–æ–≥–¥–∞ (created_at)
- –° –∫–∞–∫–∏–º IP (ip_address)

## üì¶ –§–∞–π–ª—ã –≤ –ø—Ä–æ–µ–∫—Ç–µ

1. **DATABASE_SCHEMA.md** - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–ø–æ–¥—Ä–æ–±–Ω–∞—è)
2. **DATABASE_SUMMARY.md** - –∫—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞ (—ç—Ç–æ—Ç —Ñ–∞–π–ª)
3. **supabase_migration.sql** - —Å–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
4. **supabase_improvements.sql** - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –∏ –∏–Ω–¥–µ–∫—Å–æ–≤
5. **check_database_integrity.sql** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –ë–î
6. **SUPABASE_SETUP.md** - –ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è production

- [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å `supabase_migration.sql`
- [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å `check_database_integrity.sql`
- [ ] –û—á–∏—Å—Ç–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)
- [ ] –í—ã–ø–æ–ª–Ω–∏—Ç—å `supabase_improvements.sql`
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Row Level Security
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ CRUD
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞—Å–∫–∞–¥–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞—É–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–π

## üÜò –ë—ã—Å—Ç—Ä–∞—è –ø–æ–º–æ—â—å

### –ü—Ä–æ–±–ª–µ–º–∞: –î—É–±–ª–∏–∫–∞—Ç—ã –ë–ò–ù
```sql
-- –ù–∞–π—Ç–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã
SELECT bin, COUNT(*) FROM farms GROUP BY bin HAVING COUNT(*) > 1;

-- –£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã (–æ—Å—Ç–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π)
DELETE FROM farms WHERE id NOT IN (
    SELECT MIN(id) FROM farms GROUP BY bin
);
```

### –ü—Ä–æ–±–ª–µ–º–∞: –°–∏—Ä–æ—Ç—Å–∫–∏–µ –∑–∞–ø–∏—Å–∏
```sql
-- –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Ö–æ–∑—è–π—Å—Ç–≤–∞–º–∏
SELECT u.* FROM users u
WHERE u.farm_id IS NOT NULL
    AND NOT EXISTS (SELECT 1 FROM farms f WHERE f.id = u.farm_id);

-- –ò—Å–ø—Ä–∞–≤–∏—Ç—å (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å farm_id –≤ NULL)
UPDATE users SET farm_id = NULL
WHERE farm_id IS NOT NULL
    AND NOT EXISTS (SELECT 1 FROM farms f WHERE f.id = farm_id);
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
```sql
-- –ê–Ω–∞–ª–∏–∑ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ Supabase
-- Dashboard ‚Üí Reports ‚Üí Database ‚Üí Slow Queries

-- –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–π –∏–Ω–¥–µ–∫—Å
CREATE INDEX idx_custom ON table_name(column_name);
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ Supabase Dashboard
2. –í—ã–ø–æ–ª–Ω–∏—Ç–µ `check_database_integrity.sql`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ DATABASE_SCHEMA.md –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Å–≤—è–∑–µ–π
4. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É —Å–∏—Å—Ç–µ–º—ã
