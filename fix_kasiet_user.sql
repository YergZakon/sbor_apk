-- ============================================================================
-- ИСПРАВЛЕНИЕ ПРОБЛЕМЫ ПОЛЬЗОВАТЕЛЯ kasiet_digital
-- ============================================================================

-- Проблема: Пользователь kasiet_digital (ID: 2) не привязан к хозяйству (farm_id = NULL)
-- Решение: Привязать пользователя к нужному хозяйству

-- ВАЖНО: Выберите ОДНО из решений ниже!

-- ============================================================================
-- ВАРИАНТ 1: Привязать к существующему хозяйству
-- ============================================================================

-- Шаг 1: Посмотрите доступные хозяйства
SELECT id, bin, name FROM farms ORDER BY id;

-- Результат:
-- farm_id=1: БИН 123456789111, "ТОО "Журавлевка-1"  (1 поле)
-- farm_id=2: БИН 031140000596, "ТОО "Журавлевка-1"  (5 полей)
-- farm_id=6: БИН 123456678993, "Агрофирма Азамат"   (0 полей)
-- farm_id=7: БИН 321321432432, "Агрофирма Тулпар"   (0 полей)

-- Шаг 2: Выберите нужное хозяйство и привяжите пользователя

-- Вариант A: Привязать к хозяйству farm_id=2 (БИН 031140000596, 5 полей)
UPDATE users
SET farm_id = 2
WHERE username = 'kasiet_digital';

-- Вариант B: Привязать к хозяйству farm_id=6 (Агрофирма Азамат, 0 полей)
-- UPDATE users
-- SET farm_id = 6
-- WHERE username = 'kasiet_digital';

-- Вариант C: Привязать к хозяйству farm_id=7 (Агрофирма Тулпар, 0 полей)
-- UPDATE users
-- SET farm_id = 7
-- WHERE username = 'kasiet_digital';

-- ============================================================================
-- ВАРИАНТ 2: Создать новое хозяйство для пользователя
-- ============================================================================

-- Если kasiet_digital должен иметь собственное хозяйство:

-- Шаг 1: Создать хозяйство
INSERT INTO farms (bin, name, director_name, region, total_area_ha, arable_area_ha, created_at)
VALUES (
    '123456789012',  -- ЗАМЕНИТЕ на реальный БИН (12 цифр)
    'Хозяйство Казиета',  -- ЗАМЕНИТЕ на реальное название
    'Kazbekov Kasiet',
    'Акмолинская область',  -- ЗАМЕНИТЕ на реальный регион
    100.0,  -- Общая площадь
    100.0,  -- Пашня
    NOW()
)
RETURNING id;

-- Шаг 2: Привязать пользователя к новому хозяйству
-- ЗАМЕНИТЕ NEW_FARM_ID на ID из предыдущего запроса
-- UPDATE users
-- SET farm_id = NEW_FARM_ID
-- WHERE username = 'kasiet_digital';

-- ============================================================================
-- ПРОВЕРКА ПОСЛЕ ИСПРАВЛЕНИЯ
-- ============================================================================

-- Проверить, что пользователь привязан
SELECT u.id, u.username, u.farm_id, f.name AS farm_name, f.bin
FROM users u
LEFT JOIN farms f ON u.farm_id = f.id
WHERE u.username = 'kasiet_digital';

-- Ожидаемый результат:
-- id=2, username=kasiet_digital, farm_id=НЕ NULL, farm_name=название хозяйства

-- ============================================================================
-- ДОПОЛНИТЕЛЬНО: ОЧИСТКА ДУБЛИКАТОВ ХОЗЯЙСТВ
-- ============================================================================

-- Проблема: Два хозяйства с названием "ТОО "Журавлевка-1"
-- farm_id=1 (БИН 123456789111) - 1 поле
-- farm_id=2 (БИН 031140000596) - 5 полей

-- Если farm_id=1 создан по ошибке, можно:

-- Шаг 1: Переместить поле из farm_id=1 в farm_id=2
-- UPDATE fields SET farm_id = 2 WHERE farm_id = 1;

-- Шаг 2: Удалить ошибочное хозяйство
-- DELETE FROM farms WHERE id = 1;

-- ВНИМАНИЕ: Выполняйте только если уверены!

-- ============================================================================
-- ГОТОВО!
-- ============================================================================

-- После выполнения исправлений:
-- 1. Пользователь kasiet_digital должен ВЫЙТИ из системы
-- 2. Войти снова (Login)
-- 3. Проверить страницу "Поля"
-- 4. Поля должны отображаться!

SELECT '✅ ИСПРАВЛЕНИЕ ЗАВЕРШЕНО - Перелогиньтесь в приложении!' AS result;
