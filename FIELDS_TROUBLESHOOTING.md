# –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç —Å–≤–æ–∏ –ø–æ–ª—è

## üîç –°–∏–º–ø—Ç–æ–º—ã

- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–æ–∑–¥–∞–ª —Ö–æ–∑—è–π—Å—Ç–≤–æ
- –ü–æ–ª—è —Å–æ–∑–¥–∞–Ω—ã –∏ –µ—Å—Ç—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- **–ù–û:** –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ "–ü–æ–ª—è" –æ–Ω–∏ –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è

---

## üéØ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –®–∞–≥ 1: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –æ—Ç–ª–∞–¥–∫–æ–π

–û—Ç–ª–∞–¥–æ—á–Ω—ã–π –∫–æ–¥ —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Ñ–∞–π–ª—ã:
- `pages/2_üå±_Fields.py` - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
- `modules/auth.py` - –≤—ã–≤–æ–¥–∏—Ç –æ—Ç–ª–∞–¥–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å (—Ç–µ—Ä–º–∏–Ω–∞–ª)

**–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**
```bash
streamlit run Home.py
```

**–û—Ç–∫—Ä–æ–π—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É "–ü–æ–ª—è"** –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:

```
üîç DEBUG: User ID: 1, farm_id –≤ session: None, farm.id –∏–∑ –ë–î: 1
üîç DEBUG: –í—Å–µ–≥–æ –ø–æ–ª–µ–π –≤ –ë–î –¥–ª—è farm_id=1: 5
üîç DEBUG: –ü–æ–ª–µ–π –ø–æ—Å–ª–µ filter_query_by_farm: 0
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (—Ç–µ—Ä–º–∏–Ω–∞–ª)

–í –∫–æ–Ω—Å–æ–ª–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è:
```
DEBUG filter_query_by_farm: model=Field, user_id=1, farm_id=None, hasattr=True
DEBUG filter_query_by_farm: No farm_id, returning empty
```

---

## üîß –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞ 1: farm_id –≤ session_state = None

**–°–∏–º–ø—Ç–æ–º—ã:**
- `farm_id –≤ session: None`
- `DEBUG filter_query_by_farm: No farm_id, returning empty`

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —Ö–æ–∑—è–π—Å—Ç–≤—É –ò–õ–ò session_state –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω

**–†–µ—à–µ–Ω–∏–µ –ê: –ü—Ä–∏–≤—è–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ —Ö–æ–∑—è–π—Å—Ç–≤—É (—á–µ—Ä–µ–∑ SQL)**

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –≤ Supabase SQL Editor:
```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø—Ä–∏–≤—è–∑–∫—É
SELECT id, username, farm_id FROM users WHERE username = '–í–ê–®_USERNAME';

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ID —Ö–æ–∑—è–π—Å—Ç–≤–∞
SELECT id, bin, name FROM farms;

-- –ü—Ä–∏–≤—è–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ —Ö–æ–∑—è–π—Å—Ç–≤—É
UPDATE users
SET farm_id = ID_–•–û–ó–Ø–ô–°–¢–í–ê  -- –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π ID
WHERE username = '–í–ê–®_USERNAME';
```

**–†–µ—à–µ–Ω–∏–µ –ë: –û–±–Ω–æ–≤–∏—Ç—å session_state (–ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è)**

1. –í—ã–π–¥–∏—Ç–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã (Logout)
2. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞ (Login)
3. session_state –æ–±–Ω–æ–≤–∏—Ç—Å—è —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º farm_id

---

### –ü—Ä–æ–±–ª–µ–º–∞ 2: –ü–æ–ª—è —Å–æ–∑–¥–∞–Ω—ã —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º farm_id

**–°–∏–º–ø—Ç–æ–º—ã:**
- `farm_id –≤ session: 1`
- `–í—Å–µ–≥–æ –ø–æ–ª–µ–π –≤ –ë–î –¥–ª—è farm_id=1: 0`
- –ù–æ –≤ –ë–î –µ—Å—Ç—å –ø–æ–ª—è —Å –¥—Ä—É–≥–∏–º farm_id

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ª—è –±—ã–ª–∏ —Å–æ–∑–¥–∞–Ω—ã –¥–æ –ø—Ä–∏–≤—è–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫ —Ö–æ–∑—è–π—Å—Ç–≤—É

**–†–µ—à–µ–Ω–∏–µ: –ò—Å–ø—Ä–∞–≤–∏—Ç—å farm_id —É –ø–æ–ª–µ–π**

```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –ø–æ–ª—è –∏ –∏—Ö farm_id
SELECT id, field_code, name, farm_id FROM fields;

-- –ò—Å–ø—Ä–∞–≤–∏—Ç—å farm_id –¥–ª—è –ø–æ–ª–µ–π
UPDATE fields
SET farm_id = –ü–†–ê–í–ò–õ–¨–ù–´–ô_ID  -- ID —Ö–æ–∑—è–π—Å—Ç–≤–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
WHERE farm_id = –ù–ï–ü–†–ê–í–ò–õ–¨–ù–´–ô_ID;  -- –¢–µ–∫—É—â–∏–π –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π ID
```

---

### –ü—Ä–æ–±–ª–µ–º–∞ 3: –£ —Ö–æ–∑—è–π—Å—Ç–≤–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ—Ç –ø–æ–ª–µ–π

**–°–∏–º–ø—Ç–æ–º—ã:**
- `–í—Å–µ–≥–æ –ø–æ–ª–µ–π –≤ –ë–î –¥–ª—è farm_id=1: 0`
- –ü–æ–ª—è –Ω–µ —Å–æ–∑–¥–∞–Ω—ã

**–†–µ—à–µ–Ω–∏–µ: –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—è**

1. –ß–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ü–æ–ª—è" ‚Üí –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ"
2. –ß–µ—Ä–µ–∑ SQL:
```sql
INSERT INTO fields (farm_id, field_code, name, area_ha, created_at)
VALUES (
    1,  -- ID –≤–∞—à–µ–≥–æ —Ö–æ–∑—è–π—Å—Ç–≤–∞
    'FIELD_001',
    '–¢–µ—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ',
    100.0,
    NOW()
);
```

---

### –ü—Ä–æ–±–ª–µ–º–∞ 4: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É —Ö–æ–∑—è–π—Å—Ç–≤—É

**–°–∏–º–ø—Ç–æ–º—ã:**
- `farm_id –≤ session: 999`
- –û—à–∏–±–∫–∞: "–•–æ–∑—è–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"

**–†–µ—à–µ–Ω–∏–µ:**

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —Ö–æ–∑—è–π—Å—Ç–≤–∞
SELECT * FROM farms WHERE id = 999;

-- –ï—Å–ª–∏ —Ö–æ–∑—è–π—Å—Ç–≤–∞ –Ω–µ—Ç, —É–±—Ä–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É
UPDATE users SET farm_id = NULL WHERE id = –í–ê–®_ID;

-- –ó–∞—Ç–µ–º –ø—Ä–∏–≤—è–∑–∞—Ç—å –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ö–æ–∑—è–π—Å—Ç–≤—É (—Å–º. –ü—Ä–æ–±–ª–µ–º–∞ 1)
```

---

## üîç –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —á–µ—Ä–µ–∑ SQL

–í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç `debug_fields_issue.sql` –≤ Supabase SQL Editor.

–û–Ω –ø–æ–∫–∞–∂–µ—Ç:
1. –í—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∏—Ö —Ö–æ–∑—è–π—Å—Ç–≤–∞
2. –í—Å–µ —Ö–æ–∑—è–π—Å—Ç–≤–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–µ–π
3. –í—Å–µ –ø–æ–ª—è –≤ —Å–∏—Å—Ç–µ–º–µ
4. –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–≤—è–∑–∏ (—Å–∏—Ä–æ—Ç—Å–∫–∏–µ –∑–∞–ø–∏—Å–∏)
5. –î–µ—Ç–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
6. –ò—Ç–æ–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

**–ù–µ –∑–∞–±—É–¥—å—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å:**
```sql
check_username TEXT := '–í–í–ï–î–ò–¢–ï_USERNAME_–°–Æ–î–ê';  -- –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à username!
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –ü–µ—Ä–µ–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–π–¥–∏—Ç–µ –∏ –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å session_state!

### 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—Ç–ª–∞–¥–æ—á–Ω—ã–π –≤—ã–≤–æ–¥

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
üîç DEBUG: User ID: 1, farm_id –≤ session: 1, farm.id –∏–∑ –ë–î: 1
üîç DEBUG: –í—Å–µ–≥–æ –ø–æ–ª–µ–π –≤ –ë–î –¥–ª—è farm_id=1: 5
üîç DEBUG: –ü–æ–ª–µ–π –ø–æ—Å–ª–µ filter_query_by_farm: 5
```

### 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å

–î–æ–ª–∂–Ω–æ –±—ã—Ç—å:
```
DEBUG filter_query_by_farm: model=Field, user_id=1, farm_id=1, hasattr=True
DEBUG filter_query_by_farm: Filtering by farm_id=1
```

### 4. –£–≤–∏–¥–µ–ª–∏ –ø–æ–ª—è?

–ï—Å–ª–∏ –¥–∞ - **–ø—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞!** ‚úÖ

---

## üßπ –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–ª–∞–¥–æ—á–Ω–æ–≥–æ –∫–æ–¥–∞

–ü–æ—Å–ª–µ —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è:

### –í —Ñ–∞–π–ª–µ pages/2_üå±_Fields.py

–£–¥–∞–ª–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏ 49-59:
```python
# –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
from modules.auth import get_current_user
user = get_current_user()
st.info(f"üîç DEBUG: ...")
# ... –∏ —Ç.–¥.
```

### –í —Ñ–∞–π–ª–µ modules/auth.py

–£–¥–∞–ª–∏—Ç–µ –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ —Å `print("DEBUG filter_query_by_farm: ...")`

---

## üîÑ –¢–∏–ø–∏—á–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –ø—Ä–æ–±–ª–µ–º—ã

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è ‚Üí `farm_id = NULL`
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç —Ö–æ–∑—è–π—Å—Ç–≤–æ ‚Üí —Ö–æ–∑—è–π—Å—Ç–≤–æ —Å–æ–∑–¥–∞–Ω–æ —Å `id = 1`
3. **–ù–û:** session_state –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω ‚Üí `farm_id –≤ session –≤—Å—ë –µ—â–µ NULL`
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª—è ‚Üí –ø–æ–ª—è –ù–ï —Å–æ–∑–¥–∞—é—Ç—Å—è (–Ω–µ—Ç farm_id)
5. –ò–õ–ò –ø–æ–ª—è —Å–æ–∑–¥–∞–Ω—ã —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º farm_id
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤–∏–¥–∏—Ç –ø–æ–ª—è ‚Üí –ø—Ä–æ–±–ª–µ–º–∞!

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ö–æ–∑—è–π—Å—Ç–≤–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–±–Ω–æ–≤–∏—Ç—å session_state
- –≠—Ç–æ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –∫–æ–º–º–∏—Ç–µ `f667c81`
- –ù–æ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è

---

## üìû –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–ª–æ

1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ `debug_fields_issue.sql`
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∫–æ–Ω—Å–æ–ª–∏
4. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É —Å —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π

---

## üéì –î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≤ –±—É–¥—É—â–µ–º

1. ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ–º–º–∏—Ç–∞—Ö `808277e`, `f667c81`
2. ‚úÖ –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ö–æ–∑—è–π—Å—Ç–≤–∞ session_state –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
3. ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ö–æ–∑—è–π—Å—Ç–≤–∞
4. ‚úÖ –í—Å–µ –Ω–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

–ü—Ä–æ–±–ª–µ–º–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö **–¥–æ** —ç—Ç–∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π.
