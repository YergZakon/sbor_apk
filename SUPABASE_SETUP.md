# Настройка Supabase для Farm Data System

## Шаг 1: Создание проекта в Supabase

1. Перейдите на [supabase.com](https://supabase.com)
2. Создайте новый проект
3. Выберите регион (рекомендуется ближайший к вам)
4. Установите надежный пароль для базы данных
5. Дождитесь создания проекта (2-3 минуты)

## Шаг 2: Получение данных подключения

После создания проекта:

1. Перейдите в **Settings** → **Database**
2. Найдите раздел **Connection string**
3. Выберите **URI** формат
4. Скопируйте строку подключения

Она будет выглядеть так:
```
postgresql://postgres:[YOUR-PASSWORD]@db.[YOUR-PROJECT-REF].supabase.co:5432/postgres
```

Замените `[YOUR-PASSWORD]` на ваш пароль.

## Шаг 3: Обновление .env файла

Откройте файл `.env` в корне проекта и обновите:

```env
DATABASE_URL=postgresql://postgres:[YOUR-PASSWORD]@db.[YOUR-PROJECT-REF].supabase.co:5432/postgres
```

Пример:
```env
DATABASE_URL=postgresql://postgres:YourPassword123@db.abcdefghijklmn.supabase.co:5432/postgres
```

## Шаг 4: Установка зависимостей PostgreSQL

Установите драйвер PostgreSQL для Python:

```bash
pip install psycopg2-binary
```

Убедитесь, что в `requirements.txt` есть:
```
psycopg2-binary>=2.9.0
sqlalchemy>=2.0.0
```

## Шаг 5: Выполнение SQL-миграции

### Вариант А: Через Supabase Dashboard (рекомендуется)

1. Зайдите в Supabase Dashboard
2. Перейдите в **SQL Editor** (левое меню)
3. Нажмите **New Query**
4. Откройте файл `supabase_migration.sql` из проекта
5. Скопируйте **ВСЕ** содержимое файла
6. Вставьте в SQL Editor
7. Нажмите **Run** (или F5)
8. Дождитесь выполнения (может занять 10-30 секунд)

## Шаг 6: Проверка создания таблиц

1. В Supabase Dashboard перейдите в **Table Editor**
2. Проверьте, что созданы все таблицы (18 таблиц)

## Шаг 7: Применение улучшений базы данных

После создания базовых таблиц, примените улучшения:

### Проверка текущего состояния

1. Откройте SQL Editor в Supabase
2. Выполните скрипт `check_database_integrity.sql`
3. Проверьте результаты:
   - Наличие всех таблиц
   - Существующие уникальные ключи
   - Дубликаты данных (если есть)

### Применение улучшений

1. Откройте `supabase_improvements.sql`
2. Скопируйте содержимое
3. Выполните в SQL Editor

Скрипт добавит:
- ✅ Уникальные ключи (БИН, username, email, field_code)
- ✅ Составные уникальные ключи (предотвращение дубликатов)
- ✅ Индексы для производительности
- ✅ CHECK constraints (валидация)
- ✅ Триггеры для updated_at
- ✅ CASCADE DELETE для внешних ключей
- ✅ Полезные представления (views)

**ВАЖНО:** Если в базе уже есть дубликаты, сначала очистите их!

Пример проверки дубликатов БИН:
```sql
SELECT bin, COUNT(*) FROM farms GROUP BY bin HAVING COUNT(*) > 1;
```

## Шаг 8: Тестирование подключения

Запустите приложение:

```bash
streamlit run Home.py
```

Зарегистрируйтесь как новый пользователь или войдите.

## Решение типичных проблем

### Ошибка: "no such table: users"

**Решение:**
1. Проверьте DATABASE_URL в `.env`
2. Перезапустите приложение

### Ошибка: "password authentication failed"

**Решение:**
1. Проверьте пароль в DATABASE_URL
2. Убедитесь, что специальные символы закодированы

## Безопасность

1. ✅ Настройте надежный пароль БД
2. ✅ Включите 2FA для Supabase
3. ✅ Регулярно делайте резервные копии
